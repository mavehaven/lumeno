<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LumenOS MediScan QR</title>
  <!-- Updated dependencies with specific versions -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
    .tab {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      background: #f1f1f1;
      text-align: center;
      font-weight: 600;
      transition: 0.3s;
    }
    .tab.active { background: #3498db; color: #fff; }
    .tab:hover { background: #ddd; }
    .tab.active:hover { background: #2980b9; }

    .tab-content {
      display: none;
      background: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .tab-content.active { display: block; }

    /* Form Layout */
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-section { grid-column: 1 / -1; margin-top: 20px; }
    .form-section h3 { margin-bottom: 10px; color: #3498db; border-bottom: 1px solid #eee; padding-bottom: 5px; }

    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; }
    label.required:after { content: " *"; color: red; }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea { resize: vertical; height: 80px; }

    .buttons { grid-column: 1 / -1; text-align: center; margin-top: 10px; }
    button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
      margin: 5px;
    }
    button:hover { background: #2980b9; }

    /* QR Display */
    .qr-container { text-align: center; }
    #qrcode {
      margin: 20px auto;
      padding: 16px;
      background: #fff;
      border: 4px solid #000; /* strong quiet zone */
      display: inline-block;
      border-radius: 8px;
    }
    textarea#qrData {
      width: 100%;
      height: 120px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
    }
    .qr-buttons { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    
    /* Format options */
    .format-options {
      grid-column: 1 / -1;
      margin-bottom: 15px;
      text-align: center;
    }
    .format-btn {
      background: #f1f1f1;
      color: #333;
      border: 1px solid #ddd;
      padding: 8px 15px;
      margin: 0 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    .format-btn.active {
      background: #3498db;
      color: white;
      border-color: #2980b9;
    }

    /* Data display options */
    .data-display {
      display: flex;
      margin-top: 15px;
      align-items: center;
      justify-content: center;
    }
    .data-display label {
      display: flex;
      align-items: center;
      margin-right: 15px;
      font-weight: normal;
    }
    .data-display input[type="checkbox"] {
      width: auto;
      margin-right: 5px;
    }
    
    /* QR code size control */
    .qr-size-control {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 15px 0;
    }
    .qr-size-control input {
      width: 200px;
      margin: 0 10px;
    }
    .qr-size-control span {
      min-width: 40px;
      text-align: center;
    }

    /* Hidden area for PDF */
    #print-section { display: none; }
    @media (max-width: 650px) {
      form { grid-template-columns: 1fr; }
      .qr-buttons { flex-direction: column; }
    }
    
    /* Status indicator */
    .status-indicator {
      margin-top: 10px;
      padding: 8px;
      text-align: center;
      border-radius: 4px;
      font-weight: bold;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <h1>LumenOS MediScan QR Generator</h1>

  <div class="tabs">
    <button class="tab active" onclick="openTab('formTab')">Enter Information</button>
    <button class="tab" onclick="openTab('qrTab')" id="qrTabBtn" disabled>View QR Code</button>
  </div>

  <!-- FORM TAB -->
  <div id="formTab" class="tab-content active">
    <form id="medicalForm">
      <div class="form-section"><h3>Personal Information</h3></div>

      <div class="form-group">
        <label for="fullName" class="required">Full Name</label>
        <input id="fullName" type="text" required>
      </div>
      <div class="form-group">
        <label for="dob" class="required">Date of Birth</label>
        <input id="dob" type="date" required>
      </div>
      <div class="form-group">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="">Select</option>
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="address" class="required">Address</label>
        <input id="address" type="text" required>
      </div>

      <div class="form-section"><h3>Contact Information</h3></div>

      <div class="form-group">
        <label for="phone" class="required">Phone Number</label>
        <input id="phone" type="tel" required>
      </div>
      <div class="form-group">
        <label for="email">Email Address</label>
        <input id="email" type="email">
      </div>
      <div class="form-group">
        <label for="emergencyContact" class="required">Emergency Contact Name</label>
        <input id="emergencyContact" type="text" required>
      </div>
      <div class="form-group">
        <label for="emergencyPhone" class="required">Emergency Contact Phone</label>
        <input id="emergencyPhone" type="tel" required>
      </div>

      <div class="form-section"><h3>Medical Information</h3></div>

      <div class="form-group">
        <label for="bloodType">Blood Type</label>
        <select id="bloodType">
          <option value="">Select</option>
          <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
        </select>
      </div>
      <div class="form-group">
        <label for="allergies">Known Allergies</label>
        <textarea id="allergies" placeholder="None"></textarea>
      </div>
      <div class="form-group">
        <label for="medications">Current Medications</label>
        <textarea id="medications" placeholder="None"></textarea>
      </div>
      <div class="form-group">
        <label for="medicalConditions">Existing Conditions</label>
        <textarea id="medicalConditions" placeholder="None"></textarea>
      </div>

      <div class="form-section"><h3>Admission Details</h3></div>

      <div class="form-group">
        <label for="reasonForVisit" class="required">Reason for Visit</label>
        <textarea id="reasonForVisit" required></textarea>
      </div>
      <div class="form-group">
        <label for="painLevel">Pain Level (0â€“10)</label>
        <input id="painLevel" type="range" min="0" max="10" value="0">
        <output for="painLevel" id="painLevelOutput">0</output>
      </div>

      <div class="format-options">
        <span>Data Format:</span>
        <button type="button" class="format-btn active" data-format="json" onclick="setFormat('json')">JSON (Compact)</button>
        <button type="button" class="format-btn" data-format="xml" onclick="setFormat('xml')">XML</button>
      </div>

      <div class="data-display">
        <label>
          <input type="checkbox" id="minimizeData" checked>
          Minimize non-essential data for better QR readability
        </label>
      </div>

      <div class="buttons">
        <button type="button" onclick="validateAndGenerateQR()">Generate QR Code</button>
      </div>
    </form>
  </div>

  <!-- QR TAB -->
  <div id="qrTab" class="tab-content">
    <div class="qr-container">
      <h2>Your QR Code</h2>
      
      <div class="qr-size-control">
        <span>Size:</span>
        <input type="range" id="qrSize" min="150" max="400" value="250" oninput="updateQRSize()">
        <span id="qrSizeValue">250px</span>
      </div>
      
      <div id="qrcode"></div>
      <div id="statusIndicator"></div>
      
      <textarea id="qrData" readonly></textarea>
      
      <div class="qr-buttons">
        <button onclick="regenerateQR()">Regenerate QR</button>
        <button onclick="copyQRData()">Copy Data</button>
        <button onclick="downloadDataFile()">Download Data</button>
        <button onclick="downloadQRImage()">Download QR (PNG)</button>
        <button onclick="saveAsPDF()">Save as PDF</button>
        <button onclick="backToForm()">Edit Info</button>
      </div>
    </div>
  </div>

  <!-- Hidden print area -->
  <div id="print-section">
    <div id="pdf-content">
      <h3>Medical Info QR</h3>
      <div id="pdf-qrcode"></div>
      <pre id="pdf-data" style="font-family:monospace;"></pre>
    </div>
  </div>

  <script>
    // Global variables
    let formData = {};
    let qrData = "";
    let currentFormat = "json"; // Default format (more compact)
    let qrCodeInstance = null;
    
    // Initialize pain level output
    document.getElementById('painLevel').addEventListener('input', function() {
      document.getElementById('painLevelOutput').textContent = this.value;
    });
    
    // Set data format
    function setFormat(format) {
      currentFormat = format;
      document.querySelectorAll('.format-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.format === format);
      });
    }
    
    // Tab navigation
    function openTab(tabId) {
      if (tabId === 'qrTab' && document.getElementById('qrTabBtn').disabled) return;
      document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    // Validate form and generate QR
    function validateAndGenerateQR() {
      const form = document.getElementById('medicalForm');
      const required = form.querySelectorAll('[required]');
      
      let valid = true;
      for (let f of required) {
        if (!f.value.trim()) {
          alert(`Please fill the required field: ${f.previousElementSibling.textContent.replace(' *', '')}`);
          f.focus();
          valid = false;
          break;
        }
      }
      
      if (!valid) return;
      
      generateQRCode();
      document.getElementById('qrTabBtn').disabled = false;
      openTab('qrTab');
    }

    // Collect form data
    function collectFormData() {
      const minimize = document.getElementById('minimizeData').checked;
      
      formData = {
        fullName: document.getElementById('fullName').value.trim(),
        dob: document.getElementById('dob').value,
        gender: document.getElementById('gender').value || (minimize ? null : 'Not specified'),
        address: document.getElementById('address').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim() || (minimize ? null : 'Not provided'),
        emergencyContact: document.getElementById('emergencyContact').value.trim(),
        emergencyPhone: document.getElementById('emergencyPhone').value.trim(),
        bloodType: document.getElementById('bloodType').value || (minimize ? null : 'Not specified'),
        allergies: document.getElementById('allergies').value.trim() || (minimize ? null : 'None'),
        medications: document.getElementById('medications').value.trim() || (minimize ? null : 'None'),
        conditions: document.getElementById('medicalConditions').value.trim() || (minimize ? null : 'None'),
        reasonForVisit: document.getElementById('reasonForVisit').value.trim(),
        painLevel: document.getElementById('painLevel').value,
        timestamp: new Date().toISOString()
      };
      
      // Remove null values for minimized data
      if (minimize) {
        Object.keys(formData).forEach(key => {
          if (formData[key] === null) delete formData[key];
        });
      }
    }

    // Create data in the selected format
    function formatData() {
      collectFormData();
      
      if (currentFormat === 'json') {
        return JSON.stringify({
          patient: {
            name: formData.fullName,
            dob: formData.dob,
            gender: formData.gender,
            address: formData.address,
            contact: {
              phone: formData.phone,
              email: formData.email,
              emergency: {
                name: formData.emergencyContact,
                phone: formData.emergencyPhone
              }
            },
            medical: {
              bloodType: formData.bloodType,
              allergies: formData.allergies,
              medications: formData.medications,
              conditions: formData.conditions
            },
            admission: {
              reason: formData.reasonForVisit,
              painLevel: formData.painLevel
            },
            meta: {
              generatedAt: formData.timestamp
            }
          }
        });
      } else {
        // XML format
        return `<?xml version="1.0" encoding="UTF-8"?>
<PatientRecord>
  <Name>${escapeXml(formData.fullName)}</Name>
  <DOB>${formData.dob}</DOB>
  ${formData.gender ? `<Gender>${escapeXml(formData.gender)}</Gender>` : ''}
  <Address>${escapeXml(formData.address)}</Address>
  <Contact>${formData.phone}</Contact>
  ${formData.email ? `<Email>${escapeXml(formData.email)}</Email>` : ''}
  <EmergencyContact>
    <Name>${escapeXml(formData.emergencyContact)}</Name>
    <Phone>${formData.emergencyPhone}</Phone>
  </EmergencyContact>
  <Medical>
    ${formData.bloodType ? `<BloodType>${escapeXml(formData.bloodType)}</BloodType>` : ''}
    ${formData.allergies ? `<Allergies>${escapeXml(formData.allergies)}</Allergies>` : ''}
    ${formData.medications ? `<Medications>${escapeXml(formData.medications)}</Medications>` : ''}
    ${formData.conditions ? `<Conditions>${escapeXml(formData.conditions)}</Conditions>` : ''}
  </Medical>
  <Admission>
    <Reason>${escapeXml(formData.reasonForVisit)}</Reason>
    <PainLevel>${formData.painLevel}</PainLevel>
  </Admission>
  <Meta>
    <GeneratedAt>${formData.timestamp}</GeneratedAt>
  </Meta>
</PatientRecord>`;
      }
    }
    
    // Escape XML special characters
    function escapeXml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&apos;");
    }

    // Generate QR Code
    function generateQRCode() {
      qrData = formatData();
      document.getElementById('qrData').value = qrData;
      
      const container = document.getElementById('qrcode');
      container.innerHTML = '';
      
      try {
        // Get QR code size
        const size = parseInt(document.getElementById('qrSize').value);
        
        // Create new QR code
        qrCodeInstance = new QRCode(container, {
          text: qrData,
          width: size,
          height: size,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.M // Changed to M for better balance of size/error correction
        });
        
        // Show success indicator
        showStatus('success', 'QR code generated successfully!');
        
        // Test data size
        if (qrData.length > 1000) {
          showStatus('error', 'Warning: Large data size may affect QR code readability.');
        }
      } catch (error) {
        console.error("QR generation error:", error);
        showStatus('error', 'Error generating QR code: ' + error.message);
      }
    }
    
    // Show status message
    function showStatus(type, message) {
      const indicator = document.getElementById('statusIndicator');
      indicator.className = 'status-indicator status-' + type;
      indicator.textContent = message;
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          indicator.textContent = '';
          indicator.className = 'status-indicator';
        }, 5000);
      }
    }
    
    // Update QR size
    function updateQRSize() {
      const size = document.getElementById('qrSize').value;
      document.getElementById('qrSizeValue').textContent = `${size}px`;
      
      // Regenerate QR with new size
      if (qrData) {
        regenerateQR();
      }
    }
    
    // Regenerate QR code
    function regenerateQR() {
      generateQRCode();
    }
    
    // Copy QR data to clipboard
    function copyQRData() {
      navigator.clipboard.writeText(qrData)
        .then(() => {
          showStatus('success', 'Data copied to clipboard!');
        })
        .catch(err => {
          showStatus('error', 'Failed to copy: ' + err);
        });
    }
    
    // Download data file (XML or JSON)
    function downloadDataFile() {
      const extension = currentFormat === 'json' ? 'json' : 'xml';
      const mimeType = currentFormat === 'json' ? 'application/json' : 'application/xml';
      const blob = new Blob([qrData], {type: mimeType});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `patient_data.${extension}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    
    // Download QR code as image
    function downloadQRImage() {
      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) {
        showStatus('error', 'No QR code to download');
        return;
      }
      
      try {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = 'medical_qr_code.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        showStatus('success', 'QR image downloaded');
      } catch (error) {
        showStatus('error', 'Error downloading QR: ' + error.message);
      }
    }
    
    // Save as PDF
    async function saveAsPDF() {
      try {
        // Prepare PDF content
        document.getElementById('pdf-qrcode').innerHTML = document.getElementById('qrcode').innerHTML;
        document.getElementById('pdf-data').innerText = qrData;
        const section = document.getElementById('print-section');
        section.style.display = 'block';
        
        // Generate PDF
        const canvas = await html2canvas(section);
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const width = pdf.internal.pageSize.getWidth();
        const height = (canvas.height * width) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, width, height);
        pdf.save('Medical_Info_QR.pdf');
        
        // Hide print section
        section.style.display = 'none';
        showStatus('success', 'PDF saved successfully');
      } catch (error) {
        showStatus('error', 'Error saving PDF: ' + error.message);
        document.getElementById('print-section').style.display = 'none';
      }
    }
    
    // Return to edit form
    function backToForm() {
      openTab('formTab');
    }
  </script>
</body>
</html>
